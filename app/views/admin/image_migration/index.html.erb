<section class="section">
  <div class="container">
    <h1 class="title">Image Migration Status</h1>

    <div class="columns">
      <div class="column is-half">
        <div class="box">
          <h2 class="subtitle">Migration Progress</h2>

          <div class="field">
            <label class="label">Overall Progress</label>
            <progress class="progress is-primary" value="<%= @migration_stats[:migration_progress] %>" max="100">
              <%= @migration_stats[:migration_progress] %>%
            </progress>
            <p class="help"><%= @migration_stats[:migration_progress] %>% of images available locally</p>
          </div>

          <div class="field">
            <label class="label">Storage Distribution</label>
            <table class="table is-fullwidth">
              <tbody>
                <tr>
                  <td>Total Images</td>
                  <td><strong><%= @migration_stats[:total] %></strong></td>
                </tr>
                <tr class="has-background-success-light">
                  <td>Both Local & Cloud</td>
                  <td><strong><%= @migration_stats[:both] %></strong></td>
                </tr>
                <tr class="has-background-info-light">
                  <td>Local Only</td>
                  <td><strong><%= @migration_stats[:local] %></strong></td>
                </tr>
                <tr class="has-background-warning-light">
                  <td>Cloud Only</td>
                  <td><strong><%= @migration_stats[:cloud] %></strong></td>
                </tr>
                <% if @migration_stats[:neither] > 0 %>
                <tr class="has-background-danger-light">
                  <td>Neither Available</td>
                  <td><strong><%= @migration_stats[:neither] %></strong></td>
                </tr>
                <% end %>
                <% if @migration_stats[:errors] > 0 %>
                <tr class="has-background-danger-light">
                  <td>Errors</td>
                  <td><strong><%= @migration_stats[:errors] %></strong></td>
                </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="column is-half">
        <div class="box">
          <h2 class="subtitle">Actions</h2>

          <div class="buttons">
            <button class="button is-primary" onclick="refreshStatus()">
              <span class="icon">
                <i class="fas fa-sync-alt"></i>
              </span>
              <span>Refresh Status</span>
            </button>

            <%= link_to "View Missing Images", missing_images_admin_image_migration_index_path, class: "button is-warning" %>
          </div>

          <div class="content">
            <h3>Migration Commands</h3>
            <p>Run these commands on the server:</p>

            <div class="field">
              <label class="label">Download Images</label>
              <div class="control">
                <input class="input" type="text" value="rails images:migrate_to_local" readonly>
              </div>
            </div>

            <div class="field">
              <label class="label">Check Status</label>
              <div class="control">
                <input class="input" type="text" value="rails images:migration_status" readonly>
              </div>
            </div>

            <div class="field">
              <label class="label">Fix Failed Uploads</label>
              <div class="control">
                <input class="input" type="text" value="rails images:fix_failed_uploads" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="box">
      <h2 class="subtitle">Recent Images</h2>

      <% if @recent_images.any? %>
        <table class="table is-fullwidth is-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Filename</th>
              <th>Universe</th>
              <th>Size</th>
              <th>Local</th>
              <th>Cloud</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_images.each do |image, status| %>
              <tr>
                <td><%= image.id %></td>
                <td>
                  <% if image.image_file.attached? %>
                    <%= image.image_file.blob.filename %>
                  <% else %>
                    <em>No file attached</em>
                  <% end %>
                </td>
                <td><%= image.universe.name %></td>
                <td>
                  <% if image.image_file.attached? %>
                    <%= number_to_human_size(image.image_file.blob.byte_size) %>
                  <% else %>
                    —
                  <% end %>
                </td>
                <td>
                  <span class="tag <%= status[:local] ? 'is-success' : 'is-danger' %>">
                    <%= status[:local] ? '✓' : '✗' %>
                  </span>
                </td>
                <td>
                  <span class="tag <%= status[:cloud] ? 'is-success' : 'is-danger' %>">
                    <%= status[:cloud] ? '✓' : '✗' %>
                  </span>
                </td>
                <td><%= time_ago_in_words(image.created_at) %> ago</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="has-text-grey">No images found.</p>
      <% end %>
    </div>
  </div>
</section>

<script>
function refreshStatus() {
  fetch('<%= status_admin_image_migration_index_path %>')
    .then(response => response.json())
    .then(data => {
      location.reload(); // Simple refresh for now
    })
    .catch(error => {
      console.error('Error refreshing status:', error);
      alert('Failed to refresh status');
    });
}

// Auto-refresh every 30 seconds
setInterval(refreshStatus, 30000);
</script>
