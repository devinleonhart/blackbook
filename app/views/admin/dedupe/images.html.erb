<section id="admin-dedupe-images-view" class="bb-page">
  <div class="bb-container-lg">
    <div class="flex items-start justify-between gap-4 mb-8">
      <div>
        <h1 class="bb-heading-xl">Duplicate images</h1>
      </div>
      <div class="shrink-0">
        <%= link_to "← Back to Admin", admin_root_path, class: "bb-link-strong" %>
      </div>
    </div>

    <% if @universes_with_duplicate_images.blank? %>
      <div class="bb-card bb-card--panel bb-card--bordered">
        <%= render partial: "shared/empty_banner", locals: { message: "No duplicate image uploads found." } %>
      </div>
    <% else %>
      <div class="space-y-8">
        <% @universes_with_duplicate_images.each do |entry| %>
          <% universe = entry[:universe] %>
          <% groups = entry[:groups] %>

          <div class="bb-card bb-card--panel bb-card--bordered">
            <div class="flex items-start justify-between gap-4 mb-6">
              <div>
                <h2 class="bb-heading-lg">
                  <%= link_to universe.name, universe_path(universe), class: "hover:underline" %>
                </h2>
                <p class="bb-subtitle-sm">
                  <%= pluralize(groups.size, "duplicate group") %> found in this universe.
                </p>
              </div>
              <div class="shrink-0">
                <%= form_with url: admin_dedupe_images_dedupe_universe_path, method: :post, local: true do %>
                  <%= hidden_field_tag :universe_id, universe.id %>
                  <%= submit_tag "Delete all duplicates in this universe",
                                 data: { turbo_confirm: "Keep the earliest image in EACH duplicate group and delete the rest for "#{universe.name}"? This cannot be undone." },
                                 class: "bb-btn-sm bg-red-700 hover:bg-red-800 text-white cursor-pointer" %>
                <% end %>
              </div>
            </div>

            <div class="space-y-6">
              <% groups.each do |group| %>
                <div class="rounded-lg border border-gray-200 p-4">
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                    <div>
                      <div class="text-lg font-semibold text-gray-900">
                        <%= pluralize(group[:count], "image") %> with identical file data
                      </div>
                      <div class="text-xs text-gray-500">
                        <span class="font-mono">checksum=<%= group[:checksum] %></span>
                        <span class="mx-2">•</span>
                        <span><%= number_to_human_size(group[:byte_size]) %></span>
                        <span class="mx-2">•</span>
                        <span><%= group[:content_type] %></span>
                      </div>
                    </div>

                    <div class="shrink-0">
                      <%= form_with url: admin_dedupe_images_dedupe_group_path, method: :post, local: true do %>
                        <%= hidden_field_tag :universe_id, universe.id %>
                        <%= hidden_field_tag :checksum, group[:checksum] %>
                        <%= hidden_field_tag :byte_size, group[:byte_size] %>
                        <%= hidden_field_tag :content_type, group[:content_type] %>
                        <%= submit_tag "Delete #{group[:count] - 1} Duplicate(s)", data: { turbo_confirm: "Keep the earliest image in this group and delete #{group[:count] - 1} duplicates? This cannot be undone." }, class: "bb-btn-sm bb-btn-danger cursor-pointer" %>
                      <% end %>
                    </div>
                  </div>

                  <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                      <thead>
                        <tr class="text-left text-gray-600 border-b">
                          <th class="py-2 pr-3">Image</th>
                          <th class="py-2 pr-3">Created</th>
                          <th class="py-2 pr-3">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% group[:images].each_with_index do |image, idx| %>
                          <tr class="border-b last:border-b-0">
                            <td class="py-3 pr-3">
                              <%= link_to "Image ##{image.id}", edit_universe_image_path(universe, image), class: "bb-link-strong" %>
                              <% if idx == 0 %>
                                <span class="ml-2 bb-pill bb-pill-green text-xs">keep</span>
                              <% else %>
                                <span class="ml-2 bb-pill bb-pill-gray text-xs">duplicate</span>
                              <% end %>
                            </td>
                            <td class="py-3 pr-3 text-gray-500">
                              <%= image.created_at.strftime("%Y-%m-%d %H:%M") %>
                            </td>
                            <td class="py-3 pr-3 text-gray-500">
                              <% if idx == 0 %>
                                keep
                              <% else %>
                                delete
                              <% end %>
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</section>
