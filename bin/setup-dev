#!/bin/bash

# Complete development environment setup for Blackbook (Docker).

set -e

echo "Setting up Blackbook development environment..."

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo "Docker is not running. Please start Docker and try again."
  exit 1
fi

echo "Starting database..."
docker compose up -d postgres_db

echo "Waiting for database..."
for i in $(seq 1 30); do
  if docker compose exec -T postgres_db pg_isready -U postgres >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

echo "Preparing development database..."
docker compose run --rm -e RAILS_ENV=development blackbook bundle exec rails db:prepare
docker compose run --rm -e RAILS_ENV=development blackbook bundle exec rails db:seed

echo "Preparing test database..."
docker compose run --rm -e RAILS_ENV=test blackbook bundle exec rails db:prepare

echo ""
echo "Development environment ready."
echo ""
echo "Application: http://localhost:3001"
echo ""
echo "Accounts:"
echo "  Admin: admin@blackbook.dev / password123"
echo "  Owner: owner@blackbook.dev / password123"
echo "  Collaborator: collaborator@blackbook.dev / password123"
echo ""
echo "Useful commands:"
echo "  bin/reset-db       - Reset development database"
echo "  bin/reset-test-db  - Reset test database"
echo "  docker compose logs - View application logs"
echo "  docker compose down - Stop containers"

echo "Starting app..."
docker compose up -d blackbook
